#include "fann.h"

#define MAX_WIND    30000
#define MIN_WIND    0
#define MAX_SOLAR   15000
#define MIN_SOLAR   0
#define MAX_DEMAND  60000
#define MIN_DEMAND  10000
#define MAX_PRICE   100
#define MIN_PRICE   -20

/***************************************************
 Normalise between +1/-0
***************************************************/
void normalise_wind(fann_type *arr, int num_inputs){
    for(int i=0; i<num_inputs; i++){
        arr[i] = ((arr[i] - MIN_WIND)/(MAX_WIND - MIN_WIND));
    }
}

/***************************************************
 Normalise between +1/-0
***************************************************/
void normalise_solar(fann_type *arr, int num_inputs){
    for(int i=0; i<num_inputs; i++){
        arr[i] = ((arr[i] - MIN_SOLAR)/(MAX_SOLAR - MIN_SOLAR));
    }
}

/***************************************************
 Normalise between +1/-0
***************************************************/
void normalise_demand(fann_type *arr, int num_inputs){
    for(int i=0; i<num_inputs; i++){
        arr[i] = ((arr[i] - MIN_DEMAND)/(MAX_DEMAND - MIN_DEMAND));
    }
}

/***************************************************
 Normalise between Â±1
***************************************************/
void normalise_price(fann_type *arr){
    *arr = (((*arr - MIN_PRICE)/(MAX_PRICE - MIN_PRICE)) * 2) - 1;
}

/***************************************************
 Denormalise Price
***************************************************/
void denormalise_price(fann_type *arr){
    // *arr = (((*arr - MIN_PRICE)/(MAX_PRICE - MIN_PRICE)) * 2) - 1;
    
    *arr = ((*arr + 1) / 2) * (MAX_PRICE - MIN_PRICE) + MIN_PRICE;
}

int main(){
    struct fann *ann;
    
    const float predict[13][36] = {
        {8937, 8734, 8790, 9501, 9379, 9679, 9921, 10302, 10348, 10561, 11419, 12289, 0, 0, 0, 0, 0, 2215, 4591, 2983, 116, 0, 0, 0, 23200, 22306, 21071, 24358, 31899, 33039, 32720, 33902, 36939, 39194, 37067, 31167},
        {13236, 13611, 13628, 12902, 11470, 10193, 8905, 7577, 6581, 5968, 6117, 6490, 0, 0, 0, 0, 0, 1939, 3945, 2793, 123, 0, 0, 0, 26503, 25756, 23748, 24936, 34884, 37642, 36159, 36485, 39847, 42198, 39172, 34053},
        {7171, 7742, 8190, 8039, 7895, 7795, 7774, 7127, 6582, 6166, 6074, 5802, 0, 0, 0, 0, 0, 846, 2062, 1372, 25, 0, 0, 0, 28626, 27613, 25385, 25435, 30586, 35746, 35734, 35280, 36047, 39382, 36967, 32475},
        {5408, 5936, 6661, 7714, 8750, 9275, 9659, 10660, 11762, 12500, 12913, 13377, 0, 0, 0, 0, 0, 104, 587, 502, 0, 0, 0, 0, 27625, 26572, 24572, 23682, 26393, 32932, 35370, 36984, 37065, 40077, 36001, 31160},
        {13621, 13954, 14127, 14196, 14158, 13939, 13422, 13186, 12932, 12620, 12261, 12007, 0, 0, 0, 0, 0, 440, 1563, 1262, 39, 0, 0, 0, 24972, 24287, 23013, 24542, 36428, 39735, 39319, 39388, 39875, 43039, 40186, 34105},
        {11853, 12086, 12238, 12286, 12273, 12135, 11940, 11923, 11822, 11594, 11005, 10383, 0, 0, 0, 0, 0, 1650, 3690, 2534, 106, 0, 0, 0, 27013, 26650, 25056, 26187, 36371, 40257, 39277, 38752, 40185, 43794, 41360, 34856},
        {9742, 9034, 8376, 7771, 7095, 6486, 6001, 5747, 5713, 5805, 5835, 6014, 0, 0, 0, 0, 0, 1302, 2709, 1898, 54, 0, 0, 0, 28301, 27632, 26251, 27813, 37531, 41075, 40485, 40313, 41430, 45153, 42099, 36115},
        {6334, 6744, 7282, 7784, 7913, 8064, 8233, 8306, 8427, 8540, 8384, 8275, 0, 0, 0, 0, 0, 1385, 2661, 2122, 75, 0, 0, 0, 28724, 28202, 26733, 27867, 38278, 41066, 39961, 40296, 41804, 44489, 41830, 35618},
        {8180, 8077, 8051, 8063, 8118, 8176, 8278, 8586, 8907, 9207, 9376, 9550, 0, 0, 0, 0, 0, 1180, 2267, 1697, 59, 0, 0, 0, 28319, 28323, 26481, 27430, 37421, 39972, 39725, 39221, 40317, 42845, 39661, 33857},
        {9731, 9814, 9834, 9859, 10021, 10128, 10183, 10256, 10269, 10222, 10154, 10103, 0, 0, 0, 0, 0, 1042, 1972, 1534, 49, 0, 0, 0, 27378, 26044, 24240, 24053, 28740, 33228, 33548, 33123, 35129, 39196, 36068, 31452},
        {10092, 10228, 10243, 10198, 10365, 10498, 10617, 11059, 11415, 11637, 11834, 11960, 0, 0, 0, 0, 0, 1112, 2025, 1538, 66, 0, 0, 0, 25886, 25231, 23336, 22558, 25228, 29813, 30993, 32935, 35413, 39741, 35945, 31260},
        {11976, 11879, 11712, 11569, 11786, 11903, 12012, 12258, 12407, 12448, 12487, 12394, 0, 0, 0, 0, 0, 894, 2402, 2340, 826, 0, 0, 0, 25094, 25287, 23605, 24843, 35351, 37856, 36990, 37136, 38521, 42559, 39711, 33426},
        {12243, 12334, 12313, 12166, 12175, 12019, 11850, 11981, 12012, 11953, 12041, 12032, 0, 0, 0, 0, 0, 894, 2402, 2340, 826, 0, 0, 0, 26327, 26148, 24446, 25398, 34896, 38223, 36922, 36686, 38538, 42499, 39683, 33064}
    };
 
    ann = fann_create_from_file("trained.net");
    
    for(int i=0; i<13; i++){
        normalise_wind((fann_type*)&(predict[i][0]),12);
        normalise_solar((fann_type*)&(predict[i][12]),12);
        normalise_demand((fann_type*)&(predict[i][24]),12);
    
        fann_type *calc_out = fann_run(ann, (fann_type*)&(predict[i][0]));
    
        denormalise_price(calc_out);
    
        printf("Predict: %f\n", *calc_out);
    }

    fann_destroy(ann);

    return 0;
}
